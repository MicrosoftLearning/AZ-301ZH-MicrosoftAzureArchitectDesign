---
lab:
    title: '部署消息组件以促进 Azure 资源之间的通信'
    module: '模块 4：使用消息传递服务集成 Azure 解决方案组件'
---

# 使用消息传递服务集成 Azure 解决方案组件

# 实验室答案密钥：部署消息组件以促进 Azure 资源之间的通信

## 在开始之前，

1. 请确保使用以下凭证登录到 Windows 10 实验室虚拟机：

    - 用户名：**Admin**

    - 密码：**Pa55w.rd**

2. 查看位于 Windows 10 桌面底部的任务栏。任务栏包含你在实验室中常用的应用程序图标：

    - Microsoft Edge

    - 文件资源管理器

    - [Visual Studio Code](https://code.visualstudio.com/)

    - [Microsoft Azure 存储资源管理器](https://azure.microsoft.com/features/storage-explorer/)

    - Bash on Ubuntu on Windows

    - Windows PowerShell

    > **注意**：你还可以在 **开始菜单** 中找到这些应用程序的快捷方式。

## 练习 1：部署服务总线命名空间

#### 任务 1：打开 Azure 门户

1. 单击任务栏中的 **Microsoft Edge** 图标。

2. 在打开的浏览器窗口中，导航到 **Azure 门户** (<https://portal.azure.com>)。

3. 出现提示时，使用你将在本实验室中使用的 Azure 订阅中具有所有者角色的用户账户进行身份验证。

#### 任务 2：创建服务总线命名空间

1. 在 Azure 门户的左上角，单击 **创建资源**。

2. 在 **新建** 边栏选项卡上，在 **搜索市场** 文本框中输入 **服务总线** 并按 **Enter** 键。

3. 在 **全部** 边栏选项卡上，在搜索结果中，单击 **服务总线**。

4. 在 **服务总线** 边栏选项卡上，单击 **创建** 按钮。

5. 在 **创建命名空间** 边栏选项卡上，执行以下任务：

    - 在 **名称** 文本框中，输入全球唯一名称。

    - 在 **定价等级** 下拉列表中，选择 **基础** 选项。
    
    - 将 **订阅** 下拉列表条目设置为默认值。

    - 在 **资源组** 部分，确保选中 **创建新的** 选项，然后在文本框中输入 **AADesignLab1101-RG**。

    - 在 **位置** 下拉列表中，选择你想要在本实验室中部署资源的 Azure 区域。

    - 单击 **创建** 按钮。

6. 请等待配置完成，再继续下一步。 

#### 任务 3：创建服务总线队列

1. 在 Azure 门户的主菜单中，单击 **资源组**。

2. 在 **资源组** 边栏选项卡上，单击 **AADesignLab1101-RG**。

3. 在 **AADesignLab1101-RG** 边栏选项卡上，单击新创建的服务总线命名空间。

4. 在“服务总线命名空间”边栏选项卡上，在 **实体** 部分，单击 **队列**。

5. 在“服务总线命名空间”边栏选项卡上，单击 **+ 队列** 按钮。

6. 在 **创建队列** 窗格，执行以下任务：

    - 在 **名称** 文本框中输入 **消息**。

    - 将其余所有设置均设置为默认值。

    - 单击 **创建** 按钮。

#### 任务 4：获取服务总线连接字符串

1. 返回“服务总线命名空间”边栏选项卡上，单击 **共享访问策略**。

2. 在“服务总线命名空间”边栏选项卡上，单击 **RootManageSharedAccessKey** 策略。

3. 在 **SAS 策略：RootManageSharedAccessKey** 窗格，找到并记录 **主连接字符串** 字段的值。你稍后将在本实验室中使用此值。

> **回顾**：在本练习中，你创建了一个新的服务总线命名空间并记录了一个连接字符串以访问命名空间中的队列。

## 练习 2：创建一个逻辑应用程序

#### 任务 1：创建 Azure 存储账户

1. 在 Azure 门户的左上角，单击 **创建资源**。

2. 在 **新建** 边栏选项卡上，在 **搜索市场** 文本框中输入 **存储账户** 并按 **Enter** 键。

3. 在 **全部** 边栏选项卡上，在搜索结果中，单击 **存储账户**。

4. 在 **存储账户** 边栏选项卡上，单击 **创建** 按钮。

5. 在 **创建存储账户** 边栏选项卡上，执行以下任务：

    - 在 **名称** 文本框中，输入由 3 到 24 个字符和数字组合构成的唯一名称。
    
    - 在 **部署模型** 部分，确保选中 **资源管理器** 选项。

    - 在 **账户种类** 下拉列表中，确保选中 **存储（通用 v1）** 选项。

    - 将 **位置** 条目设置为你先前在本练习中选择的同一 Azure 区域。

    - 在 **复制** 下拉列表中，选择 **本地冗余存储 (LRS)** 条目。

    - 在 **性能** 部分，确保选中 **标准** 选项。 

    - 在 **需要安全转移** 部分，确保选中 **禁用** 选项。 

    - 将 **订阅** 下拉列表条目设置为默认值。

    - 在 **资源组** 部分，确保选中 **利用现有** 选项，然后在下方下拉列表中选择你先前在本练习中创建的资源组。

    - 将 **配置虚拟网络** 选项设置为默认值。

    - 将 **分层命名空间** 选项设置为默认值。

    - 单击 **创建** 按钮。

1. 请等待配置完成，再继续下一步。

1. 在 Azure 门户的主菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡上，单击 **AADesignLab1101-RG**。

1. 在 **AADesignLab1101-RG** 选项卡上，单击新建的 Azure 存储账户。 

1. 在“存储账户”边栏选项卡上，单击 **Blob** 图块。 

1. 在“存储账户” 边栏选项卡上，单击 **+ 容器** 按钮。

1. 在 **新容器** 窗格，执行以下任务：

    - 在 **名称** 文本框中，输入 **messageoutput**。

    - 在 **公共访问级别** 下拉列表中，选择 **Blob（仅限 blob 的匿名读取访问）** 选项。

    - 单击 **确定** 按钮。

#### 任务 2：创建一个逻辑应用程序

1. 在 **新建** 边栏选项卡上，在 **搜索市场** 文本框中输入 **逻辑应用程序** 并按 **Enter** 键。

2. 在 **全部** 边栏选项卡上，在搜索结果中，单击 **逻辑应用程序**。

3. 在 **逻辑应用程序** 边栏选项卡上，单击 **创建** 按钮。

4. 在 **创建逻辑应用程序** 边栏选项卡上，执行以下任务：

    - 在 **名称** 文本框中，输入 **ServiceBusWorkflow**。
    
    - 将**订阅** 下拉列表条目设置为默认值。

    - 在 **资源组** 部分，选择 **利用现有** 选项，然后在下拉列表中选择 **AADesignLab1101-RG**。

    - 在 **位置** 下拉列表中，选择你在上一个任务中选择的同一 Azure 区域。 

    - 在 **日志分析** 部分，确保选中 **关闭** 按钮。

    - 单击 **创建** 按钮。

5. 请等待配置完成，再执行下一个任务。 

#### 任务 3：配置逻辑应用步骤。

1. 在 Azure 门户的主菜单中，单击 **资源组**。

2. 在 **资源组** 边栏选项卡上，单击 **AADesignLab1101-RG**。

3. 在 **AADesignLab1101-RG** 边栏选项卡上，单击表示你在上一个任务中创建的逻辑应用程序的条目。

4. 在 **逻辑应用程序设计器** 边栏选项卡上，向下滚动并单击 **模板** 部分的 **空白逻辑应用程序** 图块。

5. 在 **逻辑应用程序设计器** 边栏选项卡上，执行以下任务：

    - 在 **搜索连接器和触发器** 文本框中输入 **服务总线**。

    - 在搜索结果中，选择名为 **在队列中接收消息（自动完成）时 - 服务总线** 的触发器。

    - 在 **连接名称** 文本框中输入 **ServiceBusConnection**。
    
    - 在 **服务总线命名空间** 列表中，选择你先前在本实验室中创建的命名空间。

    - 在策略列表中，选择 **RootManageSharedAccessKey** 策略。

    - 单击 **创建** 按钮。

6. 在 **在队列中收到消息（自动完成）** 步骤中，执行以下任务：

    - 在 **队列名称** 下拉列表中，选择 **消息** 条目。

    - 在 **间隔时间** 文本框中输入 **30**。

    - 在 **频率** 下拉列表中，选择 **第二** 条目。

7. 在 **逻辑应用程序设计器** 边栏选项卡上，单击 **+ 新步骤** 按钮。

8. 在 **逻辑应用程序设计器** 边栏选项卡上，执行以下任务：

    - 在 **搜索连接器和操作** 文本框输入 **存储 blob**。

    - 在搜索结果中，选择名为 **创建 blob - Azure Blob 存储** 的操作。

    - 在 **连接名称** 文本框输入 **StorageConnection**。
    
    - 在 *存储账户* 列表中，选择你先前在本实验室中创建的账户。

    - 单击 **创建** 按钮。  

9. 在 **创建 Blob** 步骤中，执行以下任务：

    - 在 **文件夹路径** 文本框中输入 **/messageoutput**。

    - 在 **Blob 名称** 文本框中输入 **@concat(triggerBody()?['MessageId'], '.txt')**。

    - 在 **Blob 内容** 文本框中输入 **@string(decodeBase64(triggerBody()?['ContentData']))**。

10. 在 **逻辑应用程序设计器** 边栏选项卡上，单击 **保存** 按钮保存你的工作流程。

#### 任务 2：打开 Cloud Shell

1. 在门户顶部，单击 **Cloud Shell** 图标，打开新的 shell 实例。

    > **注意**：**Cloud Shell** 图标是由 *大于* 和 *下划线* 字符组合构成的一个符号。

2. 如果这是你第一次使用订阅打开 **Cloud Shell**，你将看到 **Cloud Shell** 首次使用的配置向导。出现提示时，在 **欢迎使用 Azure Cloud Shell** 窗格，单击 **Bash (Linux)**。

    > **注意**：如果你没有看到 **Cloud Shell** 的配置选项，这很可能是因为你在本课程的实验室中使用现有订阅。如果是，请直接进入下一个任务。 

3. 在 **尚未安装存储资源** 窗格，单击 **显示高级设置**，执行以下任务：

    - 将 **订阅** 下拉列表条目设置为默认值。

    - 在 **Cloud Shell 区域** 下拉列表中，选择与你在本实验室中部署资源的位置匹配或接近的 Azure 区域。

    - 在 **资源组** 部分，选择 **利用现有** 选项，然后在下拉列表中选择 **AADesignLab1101-RG**。

    - 在 **存储账户** 部分，确保选中 **创建新的** 选项，然后在下方文本框中输入由 3 到 24 个字符和数字组成的唯一名称。 

    - 在 **文件共享** 部分，确保选中 **创建新的** 选项，然后在下方文本框中输入 **cloudshell**。

    - 单击 **创建存储资源** 按钮

4. 等待 **Cloud Shell** 完成其首次设置过程，然后进入下一个任务。

#### 任务 4：使用 Node.js 验证逻辑应用程序

1. 在门户顶部，单击 **Cloud Shell** 图标，打开新的 shell 实例。

2. 在门户底部的 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，使用 NPM 安装 **azure** 包：

    ```sh
    npm install azure
    ```

3. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，打开交互式节点终端：

    ```sh
    node
    ```

4. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，将 **azure** 模块导入节点中：

    ```sh
    var azure = require('azure');
    ```
    > **注意**：输出结果将显示 **未定义**。这在预料之中。
    
5. 在 **Cloud Shell** 命令提示符处，输入以下命令（将占位符 `<Service Bus namespace connection string>` 替换为你先前在本实验室中记录的 URL 的值）并按 **Enter** 键，为你的服务总线命名空间连接字符串创建一个新变量：

    ```sh
    var connectionString = '<Service Bus namespace connection string>';
    ```

6. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，创建一个新客户端以连接到服务总线命名空间：

    ```sh
    var serviceBusService = azure.createServiceBusService(connectionString);
    ```

7. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，使用客户端向服务总线命名空间队列发送消息。

    ```sh
    serviceBusService.sendQueueMessage('messages', { body: 'Hello World' }, function(error) { console.log(error) });    
    ```

8. 在 Azure 门户的主菜单中，单击 **资源组**。

9. 在 **资源组** 边栏选项卡上，单击 **AADesignLab1101-RG**。

10. 在 **AADesignLab1101-RG** 边栏选项卡上，单击你先前在本实验室中创建的 Azure 存储账户。

11. 在“存储账户”边栏选项卡上，单击 **Blob** 图块。 

12. 在“存储账户容器”边栏选项卡上，单击 **messageoutput** 容器。

13. 请注意容器中新创建的 blob。

> **回顾**：在本练习中，你创建了一个逻辑应用程序，该应用程序由服务总线命名空间队列发出的消息所触发。

## 练习 3：删除实验室资源

#### 任务 1：打开 Cloud Shell

1. 在门户顶部，单击 **Cloud Shell** 图标，打开 Cloud Shell 窗格。

2. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter 键**，列出你在本实验室中创建的所有资源组：

    ```sh
    az group list --query "[?starts_with(name,'AADesignLab11')]".name --output tsv
    ```

3. 验证输出结果中是否仅包含你在本实验室中创建的资源组。这些组将在下一个任务中删除。

#### 任务 2：删除资源组

1. 在 **Cloud Shell** 命令提示符处，输入以下命令并按 **Enter** 键，删除你在本实验室中创建的资源组

    ```sh
    az group list --query "[?starts_with(name,'AADesignLab11')]".name --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

2. 关闭门户底部的 **Cloud Shell** 提示。

> **回顾**：在本练习中，你删除了本实验室中使用的资源。
