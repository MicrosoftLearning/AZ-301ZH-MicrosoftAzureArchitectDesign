---
lab:
    title: '在 Azure 中部署数据库实例'
    module: '模块 2：比较 Azure 中的数据库选项'
---

# 比较 Azure 中的数据库选项

# 实验室答案密钥：在 Azure 中部署数据库实例

## 在我们开始之前

1. 确保你已使用以下凭据登录到 Windows 10 实验室虚拟机：

    - 用户名称：**管理员**

    - 密码：**Pa55w.rd**

1. 查看位于 Windows 10 桌面底部的任务栏。任务栏包含你将在实验中使用的常见应用程序的图标：

    - Microsoft Edge

    - 文件资源管理器

    - [Visual Studio 代码](https://code.visualstudio.com/)

    - [Microsoft Azure 存储资源管理器](https://azure.microsoft.com/features/storage-explorer/)

    - Windows Ubuntu 上的 Bash

    - Windows PowerShell

    > **注意**：你还可以在 **开始菜单** 中找到这些应用程序的快捷方式。

## 练习 1：部署 Cosmos DB 数据库

#### 任务 1：打开 Azure 门户

1. 在任务栏上，单击 **Microsoft Edge** 图标。

1. 在打开的浏览器窗口中，导航至 **Azure 门户** (<https://portal.azure.com>)。

1. 如果出现提示，请使用你将在本实验室中使用的 Azure 订阅中具有所有者角色的用户帐户账号进行身份验证。

#### 任务 2：创建 Cosmos DB 数据库和数据库集

1. 在 Azure 门户的左上角，单击 **创建资源**。

1. 在 **新建**边栏选项卡顶部的 **搜索市场** 文本框中，键入 **Cosmos DB** 并按 **Enter 键**。

1. 在 **所有内容** 边栏选项卡的搜索结果中，单击 **Azure Cosmos DB**。

1. 在 **Azure Cosmos DB** 边栏选项卡上，单击 **创建** 按钮。

1. 在新的 **Azure Cosmos DB** 边栏选项卡上，执行以下任务：

    - 将 **订阅** 下拉列表项设置为其默认值。

    - 资源组：确保 **创建新的** 选择选项，然后在文本框中键入 **AADesignLab0701-RG**。

    - 在 **帐户名** 文本框中键入全局唯一值。

    - 在 **API** 下拉列表中选择 **核心 (SQL)** 选项。

    - 在 **位置** 下拉列表中选择要在本实验室中部署资源的 Azure 区域。

    - 所有其他设置保留为默认值。

    - 单击 **创建** 按钮。

1. 在执行下一步之前，请等待配置完成。

    > **注意**：部署时间应少于 5 分钟。
    
1. 导航到新创建的 Cosmos DB 帐户的边栏选项卡，然后单击 **“密钥”**。

1. 在 Cosmos DB 帐户 **“密钥”** 边栏选项卡中，记下 **“主连接字符串”** 的值。在本实验的第三个练习中，你将需要这个。

1. 单击门户顶部的 **Cloud Shell** 图标，打开新的 Shell 实例。

    > **注意**：**Cloud Shell** 图标是由 *大于号* 和 *下划线* 字符组合而成的。

1. 如果这是你第一次使用你的订阅打开 **Cloud Shell**，将看到一个首次使用 **Cloud Shell** 的配置向导。出现提示后，在 **欢迎使用 Azure Cloud Shell** 窗格中，单击 **Bash (Linux)**。

    > **注意**：如果你没有看到 **Cloud Shell** 的配置选项，这很可能是因为你正在使用本课程实验室的现有订阅。如果是，请直接进入下一个任务。 

1. 在 **你没有安装任何存储** 窗格中，单击 **显示高级设置**，执行以下任务：

    - 将 **订阅** 下拉列表项设置为其默认值。

    - 在 **Cloud Shell 区域** 下拉列表中，选择匹配或位于本任务中你之前选择的位置附近的 Azure 区域。

    - 在 **资源组** 部分，选择 **使用现有** 选项，然后在下拉列表中选择 **AADesignLab0701-RG**。

    - 在 **存储帐户** 部分，确保已选择 **创建新的** 选项，然后在下面的文本框中键入由 3 到 24 个字符和数字组成的唯一名称。 

    - 在 **文件共享** 部分，确保已选择 **创建新的** 选项，然后在下面的文本框中键入 **cloudshell**。

    - 单击 **创建储存** 按钮。

1. 在继续下一个任务之前，请等待 **Cloud Shell** 完成其首次设置过程。

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键创建一个变量，该值指定包含你在此任务中先前部署的 Azure Cosmos DB 帐户资源组名称：

```
    RESOURCE_GROUP='AADesignLab0701-RG'
```

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键创建一个变量，该值指定包含你在此任务中先前创建的 CosmosDB 帐户名称：

```sh
    COSMOSDB_NAME=$(az cosmosdb list --resource-group $RESOURCE_GROUP --query "[0].name" --output tsv)
```

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键创建一个变量，该值指定包含你在此任务中先前创建的 CosmosDB 帐户主键：

```sh
    PRIMARY_KEY=$(az cosmosdb keys list --resource-group $RESOURCE_GROUP --name $COSMOSDB_NAME --output json | jq -r '.primaryMasterKey')
```

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键创建一个变量，该值指定包含你在此任务中先前创建的 CosmosDB 帐户 URI：

```sh
    URI="https://$COSMOSDB_NAME.documents.azure.com:443/"
```

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键，以创建一个名为 **FinancialClubDatabase** 的新 CosmosDB 数据库：

```sh
    az cosmosdb database create --url-connection $URI --key $PRIMARY_KEY --db-name 'FinancialClubDatabase'
```
    
1. 在 **Cloud Shell** 命令提示符，键入以下命令并按 **Enter 键** 在新创建的数据库中创建一个名为 **MemberCollection** 的固定数据库集：

```sh
    az cosmosdb collection create --url-connection $URI --key $PRIMARY_KEY --db-name 'FinancialClubDatabase' --collection-name 'MemberCollection' --throughput 400
```

1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键，以显示 PRIMARY_KEY 变量值：

```sh
    echo $PRIMARY_KEY
```
    
1. 在 **Cloud Shell** 命令提示符键入以下命令并按 **Enter** 键，以显示 URI 变量值：

```sh
    echo $URI
```

    > **注意**：记下这些值，你将在本实验的第三个练习中用到它们。

#### 任务 3：在 Cosmos DB 中创建和查询文档

1. 在 Azure Cosmos DB 帐户边栏选项卡左侧，单击 **数据资源管理器**。

1. 在 **数据资源管理器** 窗格，单击 **FinancialClubDatabase** 节点的 **MemberCollection** 子节点。

1. 单击位于 **数据资源管理器** 窗格顶部的 **新建 SQL 查询** 按钮。

1. 在打开的 **查询 1** 选项卡中，查看默认查询：

```sql
    SELECT * FROM c
```

1. 单击查询编辑器顶部的 **执行查询** 按钮。

1. 在数据资源管理器的窗格左侧，展开 **MemberCollection** 节点。

1. 单击 **项目** 子节点，位于 **MemberCollection** 节点内部。

1. 在新打开的 **项目** 标签中，单击选项卡顶部的 **新建项目** 按钮。

1. 在 **项目** 选项卡中，用以下文档替换现有文档：

```json
    {
        "firstName": "Pennington",
        "lastName": "Oneal",
        "age": 26,
        "salary": 90000.00,
        "company": "Veraq",
        "isVested": false
    }
```

1. 单击 **保存** 按钮，位于 **项目** 标签顶部。

1. 在 **项目** 选项卡中，单击选项卡顶部的 **新建项目** 按钮。

1. 在 **项目** 选项卡中，用以下文档替换现有文档：

```json
    {
        "firstName": "Suzanne",
        "lastName": "Oneal",
        "company": "Veraq"
    }
```

1. 单击 **保存** 按钮，位于 **项目** 标签顶部。

1. 切换回 **查询 1** 选项卡，单击位于查询编辑器顶部的 **执行查询** 按钮，重新运行默认查询`SELECT * FROM c`，并查看结果。

1. 在查询编辑器中，使用以下查询替换默认查询：

```sql
    SELECT 
        c.id, 
        c.firstName, 
        c.lastName,
        c.isVested,
        c.company
    FROM 
        c
    WHERE
        IS_DEFINED(c.isVested)
```

1. 单击查询编辑器顶部的 **执行查询** 按钮并查看结果。

1. 在查询编辑器中，使用以下查询替换现有查询：

```sql
    SELECT 
        c.id, 
        c.firstName, 
        c.lastName,
        c.age
    FROM 
        c
    WHERE
        c.age > 20
```

1. 单击查询编辑器顶部的 **执行查询** 按钮并查看结果。

1. 在查询编辑器中，使用以下查询替换现有查询：

```sql
    SELECT VALUE 
        c.id 
    FROM
        c
```

1. 单击查询编辑器顶部的 **执行查询** 按钮并查看结果。

1. 在查询编辑器中，使用以下查询替换现有查询：

```sql
    SELECT VALUE { 
        "badgeNumber": SUBSTRING(c.id, 0, 8),
        "company": c.company,
        "fullName": CONCAT(c.firstName, " ", c.lastName)
    } FROM c
```

1. 单击查询编辑器顶部的 **执行查询** 按钮并查看结果。

> **回顾**：在本练习中，你创建了一个新的 Cosmos DB 帐户、数据库和数据库集、将示例项添加到集合中，并运行针对这些项目的示例查询。

## 练习 2：使用 Cosmos DB 部署应用程序

#### 任务 1：使用 Azure 资源管理器模板和 GitHub 部署 API 应用程序代码

1. 在 Azure 门户的左上角，单击 **创建资源**。

1. 在 **新建** 边栏选项卡顶部的 **搜索市场** 文本框中，键入 **模板部署** 并按 **Enter** 键。

1. 在 **所有内容** 边栏选项卡的搜索结果中，单击 **模板部署**。

1. 在 **模板部署** 边栏选项卡中单击 **创建** 按钮。

1. 在 **自定义部署** 边栏选项卡中，单击 **在编辑器中构建自己的模板** 链接。

1. 在 **编辑模板** 边栏选项卡中，单击 **加载文件** 链接。

1. 在出现的 **打开** 文件对话框中，导航至 **\\ allfiles \\ AZ-301T02 \\ Module_02 \\ LabFiles \\ Starter \\** 文件夹。

1. 选择 **api.json** 文件。

1. 单击 **打开** 按钮。

1. 返回 **编辑模板** 边栏选项卡，单击 **保存** 按钮以保留模板。

1. 返回 **自定义部署** 边栏选项卡，执行以下任务：

    - 将 **订阅** 下拉列表项设置为其默认值。

    - 在 **资源组** 部分，选择 **使用现有** 选项，然后在下拉列表中选择 **AADesignLab0701-RG**。

    - 在 **条款和条件** 部分中，单击 **我同意上述条款和条件** 复选框。

    - 单击 **购买** 按钮。

1. 在执行下一个任务之前，请等待部署完成。

    > **注意**：从源代码管理部署最多可能需要 10 分钟。

#### 任务 2：验证 API 应用程序

1. 在 Azure 门户的中心菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡中，单击 **AADesignLab0701-RG**。

1. 在 **AADesignLab0701-RG** 边栏选项卡，单击表示新创建的 App Service API 应用的条目。

1. 在 API 应用边栏选项卡的 **设置** 中，单击 **配置**。

1. 在应用程序设置边栏选项卡上，向下滚动至 **应用程序设置** 部分并执行以下任务：

    - 设置 **CosmosDB：AuthorizationKey** 的值，设置为 **首要的关键** 的值，设置先前在本实验中创建的 **Cosmos DB** 帐户。

    - 更新 **CosmosDB：EndpointUrl** 的值，设置为 **URI** 的值，设置先前在本实验中创建的 **Cosmos DB** 实例。

    - 单击窗格顶部的 **保存** 按钮。

1. 在 API 应用边栏选项卡的左侧，单击 **概述**。

1. 单击边栏选项卡顶部的 **重新开始** 按钮，当提示确认时，单击 **是**。 

1. 单击边栏选项卡顶部的 **浏览** 按钮。将会打开一个新的浏览器选项卡，显示 **Swagger UI** 主页。

    > **注意**：如果在 API 应用完全重新启动之前单击 **浏览** 按钮，则可能无法执行此任务中的剩余步骤。如果发生这种情况，请刷新浏览器，直到 API 应用程序再次运行。

1. 在 **Swagger UI** 主页，单击 **获取/文档**。

1. 单击 **试试看！** 按钮。

1. 查看请求的结果。

1. 返回 **Swagger UI** 主页，单击 **发布/填充**。

1. 在 **参数** 部分的 **选项** 参数的 **值** 字段中，粘贴以下 JSON 内容：

```json
    {
        "quantity": 50
    }
```

1. 在 **响应消息** 部分，单击 **试试看！** 按钮。

1. 查看请求的结果。

1. 返回 **Swagger UI** 主页，单击 **获取/文档**。

1. 找到 **响应消息** 部分。单击 **试试看！** 按钮。

1. 查看请求的结果。

1. 关闭新的浏览器选项卡并返回显示 Azure 门户的浏览器选项卡。

> **回顾**：在本练习中，你创建了一个新的 API 应用，使用 .NET Core DocumentDB SDK 连接至 Azure Cosmos DB 集合，并管理其文档。

## 练习 3：将 Cosmos DB 连接至 Azure 搜索

#### 任务 1：创建 Azure 搜索实例

1. 在 Azure 门户的左上角，单击 **创建资源**。

1. 在 **新建** 边栏选项卡顶部的 **搜索应用市场** 文本框中，键入 **搜索** 并按 ** Enter** 键。

1. 在 **所有内容** 边边栏选项卡的搜索结果中，单击 **Azure 搜索**。

1. 在 **Azure 搜索** 边栏选项卡上，单击 **创建** 按钮。

1. 在 **新建搜索服务** 边栏选项卡上，执行以下任务：

    - 在 **URL** 文本框中，输入全局唯一名称。记录其值。将在本实验后期用到它。

    - 将 **订阅** 下拉列表项设置为其默认值。

    - 在 **资源组** 部分，选择 **使用现有** 选项，然后在下拉列表中选择 **AADesignLab0701-RG**。

    - 在 **位置** 下拉列表中，选择匹配 Azure 区域或靠近之前在此实验中所部署的 Cosmos DB 资源。

    - 单击 **“更改定价层”**。

    - 在 **“选择定价层”** 边栏选项卡，单击 **“免费”**，然后单击 **“选择”** 按钮。

    - 单击 **“查看 + 创建”** 按钮，查看设置，然后单击 **“创建”**。

1. 在执行下一步之前，请等待配置完成。

1. 在 Azure 门户的中心菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡中，单击 **AADesignLab0701-RG**。

1. 在 **AADesignLab0701-RG** 边栏选项卡上，单击表示新创建的 Azure 搜索实例的条目。

1. 在搜索服务边栏选项卡上，单击 **密钥**。

1. 在 **密钥** 窗格中，记录 **查询密钥** 的值。将在本实验后期用到它。
    > **注意：** 查询密钥位于主密钥和辅助密钥的下方，默认情况下没有名称。

#### 任务 2：Azure 搜索中的索引 Cosmos DB 数据

1. 在 Azure 门户的中心菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡中，单击 **AADesignLab0701-RG**。

1. 在 **“AADesignLab0701-RG”** 边栏选项卡上，单击表示你先前在本实验中创建的 Azure 搜索实例的条目。

1. 在 Azure 搜索服务的 **“概述”** 边栏选项卡上，单击 **“导入数据”**，然后单击 **“下一步”**：**连接到你的数据**。

1. 在 **连接到你的数据** 选项卡中，执行以下任务：

    - 在 **“数据源”** 下拉列表中，选择 **“Cosmos DB”**。

    - 在 **名称** 文本框中，键入 **cosmosdata**。

    - 在 **“Cosmos DB 帐户”** 文本框中，键入你之前在本实验中识别的 Cosmos DB 帐户连接字符串。

    - 在 **数据库** 下拉列表中选择 **FinancialClubDatabase** 条目。

    - 在 **数据库集** 下拉列表中，选择 **MemberCollection** 条目。

    - 在 **查询** 字段中，输入以下 SQL 查询：

        SELECT 
            c.id,
            c.firstName,
            c.lastName,
            c.age,
            c.salary,
            c.company,
            c.isVested,
            c._ts
        FROM
            c
        WHERE
            c._ts >= @HighWaterMark
        ORDER BY c._ts

    - 确保选中 **查询结果按 _ts 排序** 复选框。

    - 单击 **下一步：添加认知搜索（可选）** 按钮。

1. 在 **认知搜索** 边栏选项卡，单击**跳到：自定义目标索引**按钮。

1. 在 **索引** 边栏选项卡上，执行以下任务：

    - 在 **索引名称** 文本框中，键入 **memberindex**。

    - 在 **密钥** 下拉列表中，确保 **ID** 条目被选中。

    - 表中的 **ID** 字段中，确保 **可检索**、**可筛选** 和 **可排序** 复选框已被选中。

    - 表中的 **名字** 字段中，确保 **可检索**、**可排序** 和 **可搜索** 选项被选中。

    - 表中的 **姓氏** 字段中，确保 **可检索**、**可排序** 和 **可搜索** 复选框已被选中。

    - 表中的 **年龄** 字段中，确保 **可检索**、**可筛选**、**可排序** 和 **可分面** 复选框已被选中。

    - 表中的 **薪资** 字段中，确保 **可检索**、**可筛选**、**可排序** 和 **可分面** 复选框已被选中。

    - 表中的 **公司** 字段中，确保 **可检索**、**可分面** 和 **可搜索** 复选框已被选中。

    - 表中的 **isVested** 字段中，确保 **可检索**、**可筛选**、**可排序**、**可分面** 复选框已被选中。

    - 单击 **下一步：创建一个索引器** 按钮。

1. 在 **创建一个检索程序** 边栏选项卡上，执行以下任务：

    - 在 **名称** 文本框中，键入 **cosmosmemberindexer**。

    - 在 **时间表** 部分，选择 **Custom** 选项。

    - 在 **间隔（分钟）** 文本框中，键入 **5**。

    - 在 **开始时间 (UTC)** 字段，指定当前日期并接受时间条目的默认值。

    - 确保删除了 **“跟踪删除”** 复选框，然后单击 **“提交”** 按钮。

#### 任务 3：验证 API 应用程序

1. 在 Azure 门户的中心菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡中，单击 **AADesignLab0701-RG**。

1. 在 **AADesignLab0701-RG** 边栏选项卡上，单击你先前在本实验室中创建的代表应用服务 API 应用的条目。

1. 在 API 应用边栏选项卡上，单击 **配置**。

1. 在应用程序设置边栏选项卡上，向下滚动至 **应用程序设置** 部分并执行以下任务：

    - 将 **Search:AccountName** 的设置值更新为你在本实验室先前创建的 Azure 搜索实例名称。

    - 设置 **Search:QueryKey** 的值，设置为 **QUERY KEY** 你先前在本实验中创建的 Azure 搜索实例的值。
    
    - 设置 **Search:IndexId** 的值为 **memberindex** 的值。 

    - 单击边栏选项卡顶部的 **保存** 按钮。

1. 在 API 应用边栏选项卡中，单击 **概述**。

1. 单击边栏选项卡顶部的 **重新开始** 按钮，当提示确认时，单击 **是**。 

1. 单击边栏选项卡顶部的 **浏览** 按钮。将会打开一个新的浏览器选项卡，显示 **Swagger UI** 主页。

    > **注意**：如果在 API 应用完全重新启动之前单击 **浏览** 按钮，则可能无法执行此任务中的剩余步骤。如果发生这种情况，请刷新浏览器，直到 API 应用程序再次运行。

1. 在 **Swagger UI** 主页，单击页面顶部的 **Cosmos DB API v.1.0.0**，然后选择下拉列表中的 **Cosmos DB API v.2.0.0** 选项。

1. 单击 **获取/文档/搜索**。

1. 在 **参数** 部分的 **查询** 参数的 **值** 文本框中，键入以下文本：

```
    Oneal
```

1. 在 **响应消息** 部分，单击 **试试看！** 按钮。

1. 查看请求的结果。

1. 在 **参数** 部分的 **查询** 参数的 **值** 文本框中，键入以下文本：

```
    penn*
```

1. 在 **响应消息** 部分，单击 **试试看！** 按钮。

1. 查看请求的结果。

1. 关闭新的浏览器选项卡并返回显示 Azure 门户的浏览器选项卡。

> **回顾**：在本练习中，你创建了一个 Azure 搜索实例，使用检索程序为 Azure Cosmos DB 中的文档编制索引。

## 练习 4：删除实验室资源

#### 任务 1：删除资源组

1. 在 Azure 门户的中心菜单中，单击 **资源组**。

1. 在 **资源组** 边栏选项卡中，单击 **AADesignLab0701-RG**。

1. 在 **AADesignLab0701-RG** 边栏选项卡中，单击 **删除资源组**。 

1. 在 **是否确定删除 "AADesignLab0701-RG"?** 边栏选项卡中的 **键入资源组名称** 文本框中输入 **AADesignLab0701-RG** 并单击 **删除**。


> **回顾**：在本练习中，你删除了本实验中使用的资源。
